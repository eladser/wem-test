name: ğŸ—„ï¸ SQLite Development & Build Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-sqlite-setup:
    name: ğŸ§ª Test SQLite Setup & Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: ğŸ“¦ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ” Verify Project Structure
      run: |
        echo "ğŸ—ï¸ Verifying project structure..."
        ls -la
        echo "ğŸ“‚ Backend structure:"
        ls -la backend/src/
        echo "ğŸ“ API Project:"
        ls -la backend/src/WemDashboard.API/

    - name: ğŸ“¦ Restore .NET Dependencies
      working-directory: ./backend/src/WemDashboard.API
      run: dotnet restore

    - name: ğŸ”¨ Build .NET Application
      working-directory: ./backend/src/WemDashboard.API
      run: dotnet build --no-restore --configuration Release

    - name: ğŸ—„ï¸ Test SQLite Database Creation
      working-directory: ./backend/src/WemDashboard.API
      run: |
        echo "ğŸ—„ï¸ Testing SQLite database creation..."
        
        # Create test appsettings
        cat > appsettings.Test.json << 'EOF'
        {
          "ConnectionStrings": {
            "DefaultConnection": "Data Source=test.db;Cache=Shared;Foreign Keys=true;"
          },
          "DatabaseProvider": "SQLite",
          "Jwt": {
            "Key": "WemDashboard-Test-JWT-Key-For-CI-32Characters-Minimum",
            "Issuer": "WemDashboard",
            "Audience": "WemDashboard",
            "ExpirationInMinutes": 60
          }
        }
        EOF
        
        # Test database creation and seeding
        timeout 30s dotnet run --environment Test --no-build || true
        
        # Verify database was created and has data
        if [ -f "test.db" ]; then
          echo "âœ… SQLite database created successfully"
          
          # Use SQLite command line to check if tables exist
          if command -v sqlite3 &> /dev/null; then
            echo "ğŸ“Š Database tables:"
            sqlite3 test.db ".tables"
            
            echo "ğŸ‘¥ User count:"
            sqlite3 test.db "SELECT COUNT(*) FROM Users;" || echo "Users table check failed"
            
            echo "ğŸ¢ Site count:"
            sqlite3 test.db "SELECT COUNT(*) FROM Sites;" || echo "Sites table check failed"
            
            echo "âš¡ Power data count:"
            sqlite3 test.db "SELECT COUNT(*) FROM PowerData;" || echo "PowerData table check failed"
          else
            echo "â„¹ï¸ SQLite CLI not available, skipping table verification"
          fi
          
          # Check file size (should be reasonable with sample data)
          DB_SIZE=$(stat -f%z test.db 2>/dev/null || stat -c%s test.db 2>/dev/null || echo "unknown")
          echo "ğŸ“ Database size: $DB_SIZE bytes"
          
          if [ "$DB_SIZE" != "unknown" ] && [ "$DB_SIZE" -gt 10000 ]; then
            echo "âœ… Database has reasonable size (contains data)"
          fi
        else
          echo "âŒ SQLite database was not created"
          exit 1
        fi

    - name: ğŸ“¦ Install Frontend Dependencies
      run: npm install

    - name: ğŸ” Frontend Type Check
      run: npm run type-check

    - name: ğŸ§ª Frontend Tests
      run: npm run test -- --passWithNoTests

    - name: ğŸ—ï¸ Build Frontend
      run: npm run build

    - name: ğŸ“Š Build Summary
      run: |
        echo "ğŸ‰ Build Summary:"
        echo "âœ… .NET Backend build successful"
        echo "âœ… SQLite database creation successful"
        echo "âœ… Frontend build successful"
        echo ""
        echo "ğŸ“ Generated files:"
        echo "ğŸ—„ï¸ SQLite Database: $(ls -la backend/src/WemDashboard.API/*.db 2>/dev/null || echo 'None found')"
        echo "ğŸŒ Frontend Dist: $(ls -la dist/ 2>/dev/null || echo 'None found')"

  test-demo-workflow:
    name: ğŸ¯ Test Demo Setup Process
    runs-on: ubuntu-latest
    needs: test-sqlite-setup
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: ğŸ“¦ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ¯ Test Enhanced Setup Script
      run: |
        echo "ğŸ¯ Testing the enhanced SQLite setup script..."
        chmod +x setup-sqlite-dev.sh
        
        # Run setup script in test mode (without interactive parts)
        timeout 60s ./setup-sqlite-dev.sh || true
        
        echo "ğŸ“Š Verifying setup results..."
        
        # Check if database was created
        if [ -f "backend/src/WemDashboard.API/wemdashboard-dev.db" ]; then
          echo "âœ… Development database created successfully"
        else
          echo "â„¹ï¸ Development database not found (may be expected in CI)"
        fi
        
        # Check if frontend config was created
        if [ -f ".env.local" ]; then
          echo "âœ… Frontend environment configuration created"
          cat .env.local
        fi
        
        echo "ğŸ‰ Setup script test completed"

  compatibility-check:
    name: ğŸ”„ Cross-Platform Compatibility
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: ğŸ”¨ Build Backend
      working-directory: ./backend/src/WemDashboard.API
      run: |
        dotnet restore
        dotnet build --configuration Release

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ—ï¸ Build Frontend
      run: |
        npm install
        npm run build

    - name: âœ… Platform Test Complete
      run: echo "âœ… Build successful on ${{ matrix.os }}"
